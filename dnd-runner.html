<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Endless Dungeon â€” Runner</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');

  :root {
    --gold: #c9a84c;
    --gold-light: #f0d080;
    --dark: #0d0a06;
    --blood: #8b1a1a;
    --stone: #3a3028;
    --stone-light: #5a4a3a;
    --glow: rgba(201,168,76,0.4);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--dark);
    font-family: 'Crimson Text', Georgia, serif;
    overflow: hidden;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .screen { display: none; width: 100vw; height: 100vh; }
  .screen.active { display: flex; }

  .screen-bg::before {
    content: '';
    position: absolute;
    inset: 0;
    pointer-events: none;
    background-image:
      repeating-linear-gradient(0deg, transparent, transparent 60px, rgba(201,168,76,0.03) 60px, rgba(201,168,76,0.03) 61px),
      repeating-linear-gradient(90deg, transparent, transparent 60px, rgba(201,168,76,0.03) 60px, rgba(201,168,76,0.03) 61px);
  }

  .divider {
    width: 240px;
    height: 1px;
    background: linear-gradient(to right, transparent, var(--gold), transparent);
    margin: 16px auto;
    position: relative;
  }
  .divider::before {
    content: 'âš”';
    position: absolute;
    left: 50%; top: 50%;
    transform: translate(-50%, -50%);
    background: #1a1208;
    padding: 0 10px;
    color: var(--gold);
    font-size: 14px;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â• LANDING â•â•â•â•â•â•â•â•â•â•â•â• */
  #landingScreen {
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: radial-gradient(ellipse at center, #1a1208 0%, #0d0a06 70%);
    position: relative;
    overflow: hidden;
  }

  .landing-crest {
    font-size: 72px;
    margin-bottom: 16px;
    filter: drop-shadow(0 0 20px rgba(201,168,76,0.5));
    animation: float 4s ease-in-out infinite;
  }
  @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }

  .landing-title {
    font-family: 'Cinzel', serif;
    font-size: clamp(32px, 6vw, 64px);
    font-weight: 900;
    color: var(--gold-light);
    text-shadow: 0 0 40px var(--glow), 0 2px 0 #5a3a00;
    line-height: 1.1;
    text-align: center;
  }
  .landing-title span {
    display: block;
    font-size: 0.4em;
    font-weight: 400;
    color: var(--gold);
    letter-spacing: 4px;
    opacity: 0.8;
    margin-top: 6px;
  }

  .landing-buttons {
    display: flex;
    flex-direction: column;
    gap: 14px;
    margin-top: 40px;
    align-items: center;
  }

  .btn-primary {
    font-family: 'Cinzel', serif;
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 4px;
    text-transform: uppercase;
    color: var(--dark);
    background: linear-gradient(135deg, var(--gold-light), var(--gold));
    border: none;
    padding: 16px 56px;
    cursor: pointer;
    border-radius: 3px;
    box-shadow: 0 4px 20px rgba(201,168,76,0.4);
    transition: transform 0.15s, box-shadow 0.15s;
    width: 280px;
  }
  .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(201,168,76,0.6); }

  .btn-secondary {
    font-family: 'Cinzel', serif;
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--gold);
    background: transparent;
    border: 1px solid var(--stone-light);
    padding: 14px 56px;
    cursor: pointer;
    border-radius: 3px;
    transition: transform 0.15s, border-color 0.15s, box-shadow 0.15s;
    width: 280px;
  }
  .btn-secondary:hover { border-color: var(--gold); transform: translateY(-2px); box-shadow: 0 4px 16px rgba(201,168,76,0.2); }

  /* â•â•â•â•â•â•â•â•â•â•â•â• LEADERBOARD â•â•â•â•â•â•â•â•â•â•â•â• */
  #leaderboardScreen {
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: radial-gradient(ellipse at center, #1a1208 0%, #0d0a06 70%);
    position: relative;
    overflow: hidden;
    padding: 20px;
  }

  .lb-title {
    font-family: 'Cinzel', serif;
    font-size: clamp(20px, 3.5vw, 36px);
    font-weight: 900;
    color: var(--gold-light);
    text-shadow: 0 0 30px var(--glow);
    text-align: center;
    margin-bottom: 6px;
  }
  .lb-subtitle {
    font-family: 'Cinzel', serif;
    font-size: 10px;
    letter-spacing: 4px;
    color: var(--gold);
    opacity: 0.6;
    text-transform: uppercase;
    text-align: center;
    margin-bottom: 28px;
  }

  .lb-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
    gap: 10px;
    width: 100%;
    max-width: 880px;
    max-height: 58vh;
    overflow-y: auto;
    padding: 4px;
  }
  .lb-grid::-webkit-scrollbar { width: 4px; }
  .lb-grid::-webkit-scrollbar-thumb { background: var(--stone-light); border-radius: 2px; }

  .lb-card {
    background: linear-gradient(160deg, #1e1812, #0f0c08);
    border: 1px solid var(--stone);
    border-radius: 4px;
    padding: 12px 10px;
    display: flex;
    align-items: center;
    gap: 10px;
    position: relative;
    transition: border-color 0.2s;
  }
  .lb-card.has-score { border-color: #4a3820; }
  .lb-card.top-score { border-color: var(--gold); box-shadow: 0 0 14px rgba(201,168,76,0.25); }

  .lb-rank { font-family: 'Cinzel', serif; font-size: 11px; color: #5a4a3a; min-width: 18px; text-align: center; }
  .lb-card.top-score .lb-rank { color: var(--gold); }

  .lb-portrait {
    width: 36px; height: 36px;
    border-radius: 3px;
    overflow: hidden;
    background: #2a2018;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
  }
  .lb-portrait img { width: 100%; height: 100%; object-fit: cover; object-position: top center; }

  .lb-info { flex: 1; min-width: 0; }
  .lb-name { font-family: 'Cinzel', serif; font-size: 11px; font-weight: 700; color: var(--gold); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
  .lb-class { font-size: 10px; color: #6a5a44; font-style: italic; display: block; }

  .lb-score-val { font-family: 'Cinzel', serif; font-size: 18px; font-weight: 900; color: var(--gold-light); text-align: right; white-space: nowrap; }
  .lb-card:not(.has-score) .lb-score-val { font-size: 13px; color: #3a2a18; }

  .lb-crown { position: absolute; top: -9px; right: 8px; font-size: 16px; }

  .lb-loading { font-family: 'Cinzel', serif; color: var(--gold); font-size: 13px; letter-spacing: 3px; opacity: 0.6; animation: pulse 1.5s ease-in-out infinite; grid-column: 1/-1; text-align: center; padding: 40px 0; }
  @keyframes pulse { 0%,100%{opacity:0.6} 50%{opacity:0.2} }

  .lb-back { margin-top: 22px; width: 200px; }

  /* â•â•â•â•â•â•â•â•â•â•â•â• CHARACTER SELECT â•â•â•â•â•â•â•â•â•â•â•â• */
  #selectScreen {
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: radial-gradient(ellipse at center, #1a1208 0%, #0d0a06 70%);
    position: relative;
    overflow: hidden;
  }

  .title-block { text-align: center; margin-bottom: 28px; position: relative; }
  .title-block .eyebrow { font-family: 'Cinzel', serif; color: var(--gold); font-size: 11px; letter-spacing: 6px; text-transform: uppercase; opacity: 0.7; margin-bottom: 8px; }

  h1 { font-family: 'Cinzel', serif; font-size: clamp(22px, 4vw, 44px); font-weight: 900; color: var(--gold-light); text-shadow: 0 0 40px var(--glow), 0 2px 0 #5a3a00; line-height: 1.1; }
  h1 span { display: block; font-size: 0.45em; font-weight: 400; color: var(--gold); letter-spacing: 3px; opacity: 0.8; }

  .select-prompt { font-family: 'Cinzel', serif; color: var(--gold); font-size: 13px; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 20px; opacity: 0.8; }

  .character-grid {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 960px;
    padding: 0 20px;
    max-height: 48vh;
    overflow-y: auto;
  }
  .character-grid::-webkit-scrollbar { width: 4px; }
  .character-grid::-webkit-scrollbar-thumb { background: var(--stone-light); border-radius: 2px; }

  .char-card { width: 105px; cursor: pointer; position: relative; transition: transform 0.2s; flex-shrink: 0; }
  .char-card:hover { transform: translateY(-5px); }
  .char-card.selected .card-inner { border-color: var(--gold-light); box-shadow: 0 0 20px var(--glow), inset 0 0 20px rgba(201,168,76,0.1); }
  .char-card.selected .char-name { color: var(--gold-light); }

  .card-inner { border: 2px solid var(--stone-light); background: linear-gradient(160deg, #1e1812, #0f0c08); border-radius: 4px; overflow: hidden; transition: border-color 0.2s, box-shadow 0.2s; }

  .portrait-area { width: 100%; height: 105px; background: linear-gradient(135deg, #2a2018, #1a1208); display: flex; align-items: center; justify-content: center; overflow: hidden; }
  .portrait-area img { width: 100%; height: 100%; object-fit: cover; object-position: top center; }
  .portrait-placeholder { font-size: 40px; opacity: 0.6; }

  .char-info { padding: 7px; text-align: center; border-top: 1px solid var(--stone); }
  .char-name { font-family: 'Cinzel', serif; font-size: 10px; font-weight: 700; color: var(--gold); display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .char-class { font-size: 10px; color: #8a7a60; font-style: italic; display: block; margin-top: 1px; }

  .selected-badge { position: absolute; top: 5px; right: 5px; background: var(--gold); color: var(--dark); font-size: 9px; font-family: 'Cinzel', serif; font-weight: 700; padding: 2px 5px; border-radius: 2px; display: none; }
  .char-card.selected .selected-badge { display: block; }

  .select-actions { display: flex; gap: 12px; margin-top: 20px; align-items: center; }

  .start-btn { font-family: 'Cinzel', serif; font-size: 13px; font-weight: 700; letter-spacing: 4px; text-transform: uppercase; color: var(--dark); background: linear-gradient(135deg, var(--gold-light), var(--gold)); border: none; padding: 13px 40px; cursor: pointer; border-radius: 3px; box-shadow: 0 4px 20px rgba(201,168,76,0.4); transition: transform 0.15s, box-shadow 0.15s; opacity: 0.4; pointer-events: none; }
  .start-btn.ready { opacity: 1; pointer-events: all; }
  .start-btn.ready:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(201,168,76,0.6); }

  .back-btn { font-family: 'Cinzel', serif; font-size: 12px; letter-spacing: 2px; text-transform: uppercase; color: #8a7a60; background: transparent; border: 1px solid var(--stone); padding: 13px 20px; cursor: pointer; border-radius: 3px; transition: border-color 0.15s, color 0.15s; }
  .back-btn:hover { border-color: var(--stone-light); color: var(--gold); }

  /* â•â•â•â•â•â•â•â•â•â•â•â• GAME SCREEN â•â•â•â•â•â•â•â•â•â•â•â• */
  #gameScreen { flex-direction: column; align-items: center; justify-content: center; background: #0d0a06; position: relative; }

  .hud { position: absolute; top: 0; left: 0; right: 0; height: 60px; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); display: flex; align-items: center; justify-content: space-between; padding: 0 24px; z-index: 10; }
  .hud-name { font-family: 'Cinzel', serif; color: var(--gold); font-size: 13px; letter-spacing: 2px; }
  .hud-score { font-family: 'Cinzel', serif; color: var(--gold-light); font-size: 20px; font-weight: 700; text-shadow: 0 0 20px var(--glow); text-align: center; }
  .hud-score .label { font-size: 9px; letter-spacing: 3px; color: var(--gold); display: block; opacity: 0.7; }
  .hud-best { font-family: 'Cinzel', serif; color: #8a7a60; font-size: 12px; text-align: right; }

  canvas { display: block; border: 2px solid var(--stone); box-shadow: 0 0 60px rgba(0,0,0,0.8), 0 0 20px rgba(201,168,76,0.1); }

  .controls-hint { position: absolute; bottom: 16px; font-family: 'Cinzel', serif; font-size: 10px; color: #5a4a3a; letter-spacing: 2px; text-transform: uppercase; }

  /* â•â•â•â•â•â•â•â•â•â•â•â• GAME OVER â•â•â•â•â•â•â•â•â•â•â•â• */
  #overScreen { flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(ellipse at center, #1a0808 0%, #0d0a06 70%); }

  .over-rune { font-size: 60px; margin-bottom: 16px; animation: pulse 2s ease-in-out infinite; }
  .over-title { font-family: 'Cinzel', serif; font-size: clamp(24px, 4vw, 48px); font-weight: 900; color: var(--blood); text-shadow: 0 0 30px rgba(139,26,26,0.6); margin-bottom: 8px; }
  .over-flavor { font-family: 'Crimson Text', serif; font-style: italic; color: #8a7a60; font-size: 16px; margin-bottom: 32px; }

  .over-scores { background: rgba(201,168,76,0.06); border: 1px solid var(--stone-light); border-radius: 4px; padding: 24px 48px; margin-bottom: 32px; text-align: center; }
  .over-score-val { font-family: 'Cinzel', serif; font-size: 48px; font-weight: 900; color: var(--gold-light); text-shadow: 0 0 20px var(--glow); display: block; line-height: 1; }
  .over-score-label { font-family: 'Cinzel', serif; font-size: 10px; letter-spacing: 4px; color: var(--gold); opacity: 0.6; text-transform: uppercase; display: block; margin-bottom: 16px; }
  .over-best { font-family: 'Cinzel', serif; font-size: 13px; color: #8a7a60; }
  .over-best strong { color: var(--gold); }

  .new-record { font-family: 'Cinzel', serif; font-size: 12px; color: var(--gold-light); letter-spacing: 3px; text-transform: uppercase; background: rgba(201,168,76,0.15); padding: 4px 16px; border: 1px solid var(--gold); border-radius: 2px; margin-top: 8px; display: none; }
  .new-record.show { display: block; }

  .over-buttons { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; }

  .btn-retry, .btn-menu, .btn-lb {
    font-family: 'Cinzel', serif; font-size: 12px; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; border: none; padding: 12px 28px; cursor: pointer; border-radius: 3px; transition: transform 0.15s, box-shadow 0.15s;
  }
  .btn-retry { background: linear-gradient(135deg, var(--gold-light), var(--gold)); color: var(--dark); box-shadow: 0 4px 16px rgba(201,168,76,0.3); }
  .btn-retry:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(201,168,76,0.5); }
  .btn-menu { background: transparent; color: var(--gold); border: 1px solid var(--stone-light); }
  .btn-menu:hover { border-color: var(--gold); transform: translateY(-2px); }
  .btn-lb { background: transparent; color: #8a7a60; border: 1px solid var(--stone); }
  .btn-lb:hover { border-color: var(--stone-light); color: var(--gold); transform: translateY(-2px); }
</style>
</head>
<body>

<!-- â•â•â•â•â•â• LANDING â•â•â•â•â•â• -->
<div id="landingScreen" class="screen active screen-bg">
  <div class="landing-crest">ğŸ°</div>
  <h2 class="landing-title">
    The Endless Dungeon
    <span>âˆ™ Runner âˆ™</span>
  </h2>
  <div class="divider"></div>
  <div class="landing-buttons">
    <button class="btn-primary" onclick="showScreen('selectScreen')">âš” Start New Run</button>
    <button class="btn-secondary" onclick="openLeaderboard()">ğŸ† Top Scores</button>
    <button class="btn-secondary" onclick="window.location.href='https://www.iwottrpg.com'">â¬… Exit to Homepage</button>
  </div>
</div>

<!-- â•â•â•â•â•â• LEADERBOARD â•â•â•â•â•â• -->
<div id="leaderboardScreen" class="screen screen-bg">
  <h2 class="lb-title">Hall of Legends</h2>
  <p class="lb-subtitle">Greatest Run â€” One Champion per Hero</p>
  <div class="lb-grid" id="lbGrid">
    <p class="lb-loading">Consulting the ancient scrolls...</p>
  </div>
  <button class="btn-secondary lb-back" onclick="showScreen('landingScreen')">â† Return</button>
</div>

<!-- â•â•â•â•â•â• CHARACTER SELECT â•â•â•â•â•â• -->
<div id="selectScreen" class="screen screen-bg">
  <div class="title-block">
    <p class="eyebrow">Choose Wisely</p>
    <h1>The Endless Dungeon<span>âˆ™ Runner âˆ™</span></h1>
    <div class="divider"></div>
  </div>
  <p class="select-prompt">Choose Your Champion</p>
  <div class="character-grid" id="charGrid"></div>
  <div class="select-actions">
    <button class="back-btn" onclick="showScreen('landingScreen')">â† Back</button>
    <button class="start-btn" id="startBtn" onclick="startGame()">Begin the Run</button>
  </div>
</div>

<!-- â•â•â•â•â•â• GAME â•â•â•â•â•â• -->
<div id="gameScreen" class="screen">
  <div class="hud">
    <div class="hud-name" id="hudName">â€”</div>
    <div class="hud-score">
      <span class="label">Distance</span>
      <span id="hudScore">0</span>
    </div>
    <div class="hud-best" id="hudBest">Best: 0</div>
  </div>
  <canvas id="gameCanvas"></canvas>
  <p class="controls-hint">Space / Tap â€” Jump &nbsp;|&nbsp; Double-tap â€” Double Jump</p>
</div>

<!-- â•â•â•â•â•â• GAME OVER â•â•â•â•â•â• -->
<div id="overScreen" class="screen">
  <div class="over-rune" id="overRune">ğŸ’€</div>
  <h2 class="over-title">You Have Fallen</h2>
  <p class="over-flavor" id="overFlavor">"The dungeon claims another soul..."</p>
  <div class="over-scores">
    <span class="over-score-label">Distance Traveled</span>
    <span class="over-score-val" id="overScore">0</span>
    <div class="new-record" id="newRecord">âœ¦ New Record âœ¦</div>
    <br>
    <span class="over-best" id="overBest">Personal Best: <strong>0</strong></span>
  </div>
  <div class="over-buttons">
    <button class="btn-retry" onclick="retryGame()">Try Again</button>
    <button class="btn-lb" onclick="openLeaderboard()">ğŸ† Leaderboard</button>
    <button class="btn-menu" onclick="showScreen('landingScreen')">Main Menu</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIGURATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CHARACTERS = [
  { name: "Baradren",      charClass: "Ranger",    portrait: "images/baradren.jpeg",      sprite: "game_art/baradren_game_art.png",    emoji: "ğŸ¹" },
  { name: "Fuzzy",         charClass: "Cleric",    portrait: "images/angus.jpeg",         sprite: "game_art/angus_game_art.png",       emoji: "âœï¸" },
  { name: "Crow",          charClass: "Rogue",     portrait: "images/crow.jpeg",          sprite: "game_art/crow_game_art.png",        emoji: "ğŸ—¡ï¸" },
  { name: "Elias",         charClass: "Wizard",    portrait: "images/elias.jpeg",         sprite: "game_art/elias_game_art.png",       emoji: "ğŸ”®" },
  { name: "Farghus",       charClass: "Barbarian", portrait: "images/farghus.jpeg",       sprite: "game_art/farghus_game_art.png",     emoji: "ğŸª“" },
  { name: "LL",            charClass: "Paladin",   portrait: "images/gingerbeard.jpeg",   sprite: "game_art/gingerbeard_game_art.png", emoji: "ğŸ›¡ï¸" },
  { name: "Lucyana",       charClass: "Warlock",   portrait: "images/lucyana.jpeg",       sprite: "game_art/lucyana_game_art.png",     emoji: "ğŸ™" },
  { name: "Obadiah",       charClass: "Fighter",   portrait: "images/obadiah.jpeg",       sprite: "game_art/obadiah_game_art.png",     emoji: "âš”ï¸" },
  { name: "Storm Elder",   charClass: "Fighter",   portrait: "images/older.jpeg",         sprite: "game_art/older_game_art.png",       emoji: "âš”ï¸" },
  { name: "Perkas",        charClass: "Wizard",    portrait: "images/perkas.jpeg",        sprite: "game_art/perkas_game_art.png",      emoji: "ğŸ”®" },
  { name: "Squeak",        charClass: "Artificer", portrait: "images/squeak.jpeg",        sprite: "game_art/squeak_game_art.png",      emoji: "ğŸ”«" },
  { name: "Storm Younger", charClass: "Barbarian", portrait: "images/younger.jpeg",       sprite: "game_art/younger_game_art.png",     emoji: "ğŸª“" },
];

const DEATH_FLAVORS = [
  '"The dungeon claims another soul..."',
  '"Even the brave must fall eventually."',
  '"Darkness swallows the light."',
  '"A valiant effort, adventurer."',
  '"The monsters feast tonight."',
  '"Retreat! To fight another day."',
];

const JSONBIN_ID  = '69967828ae596e708f35ef59';
const JSONBIN_KEY = '$2a$10$dmmW.BkgP6HNVGgCTh8rUeO7XwnMgZviE3DE630J5m/QVyjXyiYdy';
const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PERSISTENT SCORE STORAGE â€” JSONBin
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAllScores() {
  try {
    const res = await fetch(JSONBIN_URL + '/latest', {
      headers: { 'X-Master-Key': JSONBIN_KEY }
    });
    const data = await res.json();
    return data.record?.scores || {};
  } catch(e) {
    console.warn('Score load failed:', e);
    return {};
  }
}

async function saveScore(charIndex, score) {
  try {
    const scores = await loadAllScores();
    const charName = CHARACTERS[charIndex].name;
    if (!scores[charName] || score > scores[charName]) {
      scores[charName] = score;
      await fetch(JSONBIN_URL, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-Master-Key': JSONBIN_KEY
        },
        body: JSON.stringify({ scores })
      });
      return score;
    }
    return scores[charName];
  } catch(e) {
    console.warn('Score save failed:', e);
    return score;
  }
}

async function getCharBest(charIndex) {
  const scores = await loadAllScores();
  return scores[CHARACTERS[charIndex].name] || 0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LEADERBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function openLeaderboard() {
  showScreen('leaderboardScreen');
  const grid = document.getElementById('lbGrid');
  grid.innerHTML = '<p class="lb-loading">Consulting the ancient scrolls...</p>';

  const scores = await loadAllScores();

  const ranked = CHARACTERS
    .map((c, i) => ({ ...c, index: i, score: scores[c.name] || 0 }))
    .sort((a, b) => b.score - a.score);

  const topScore = ranked[0]?.score || 0;

  grid.innerHTML = '';
  ranked.forEach((c, rank) => {
    const hasScore = c.score > 0;
    const isTop = hasScore && c.score === topScore;
    const card = document.createElement('div');
    card.className = `lb-card${hasScore ? ' has-score' : ''}${isTop ? ' top-score' : ''}`;
    card.innerHTML = `
      ${isTop ? '<div class="lb-crown">ğŸ‘‘</div>' : ''}
      <div class="lb-rank">${hasScore ? rank + 1 : 'â€”'}</div>
      <div class="lb-portrait">
        ${c.portrait
          ? `<img src="${c.portrait}" alt="${c.name}" onerror="this.style.display='none';this.parentElement.textContent='${c.emoji}'">`
          : c.emoji}
      </div>
      <div class="lb-info">
        <span class="lb-name">${c.name}</span>
        <span class="lb-class">${c.charClass}</span>
      </div>
      <div class="lb-score-val">${hasScore ? c.score : 'â€”'}</div>
    `;
    grid.appendChild(card);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHARACTER SELECT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let selectedChar = null;

function buildCharGrid() {
  const grid = document.getElementById('charGrid');
  grid.innerHTML = '';
  CHARACTERS.forEach((c, i) => {
    const card = document.createElement('div');
    card.className = 'char-card';
    card.setAttribute('data-index', i);
    card.innerHTML = `
      <div class="card-inner">
        <div class="portrait-area">
          ${c.portrait
            ? `<img src="${c.portrait}" alt="${c.name}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
               <div class="portrait-placeholder" style="display:none">${c.emoji}</div>`
            : `<div class="portrait-placeholder">${c.emoji}</div>`}
        </div>
        <div class="char-info">
          <span class="char-name">${c.name}</span>
          <span class="char-class">${c.charClass}</span>
        </div>
      </div>
      <div class="selected-badge">Selected</div>
    `;
    grid.appendChild(card);
  });

  grid.addEventListener('click', function(e) {
    const card = e.target.closest('.char-card');
    if (!card) return;
    const idx = parseInt(card.getAttribute('data-index'));
    selectChar(idx);
  });
}

function selectChar(idx) {
  selectedChar = idx;
  document.querySelectorAll('.char-card').forEach((c, i) => c.classList.toggle('selected', i === idx));
  const btn = document.getElementById('startBtn');
  btn.classList.add('ready');
  btn.style.opacity = '1';
  btn.style.pointerEvents = 'all';
}

buildCharGrid();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCREEN MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (id !== 'gameScreen') { gameRunning = false; cancelAnimationFrame(animId); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let W, H, GROUND;
let gameRunning = false;
let animId;
let score, speed, frameCount;
let jumpCount;
let charImg = null;
let localBest = 0;

const player = { x:0, y:0, w:64, h:96, vy:0, grounded:false };

const GRAVITY = 0.55;
const JUMP_FORCE = -13;
const BASE_SPEED = 4;
const SPEED_INC = 0.0008;

let obstacles = [];
let obstacleTimer = 0;
let nextObstacleIn = 90;
let bgLayers;

function resizeCanvas() {
  W = Math.min(window.innerWidth - 40, 900);
  H = Math.min(window.innerHeight - 120, 480);
  canvas.width = W;
  canvas.height = H;
  GROUND = H - 80;
  player.x = 80;
  if (!gameRunning) player.y = GROUND - player.h;
}

function initBgLayers() {
  bgLayers = [
    { x: 0, speed: 0.3, items: generateBgItems(8, 'far') },
    { x: 0, speed: 0.7, items: generateBgItems(6, 'mid') },
    { x: 0, speed: 1.2, items: generateBgItems(5, 'near') },
  ];
}

function generateBgItems(count, layer) {
  const items = [];
  for (let i = 0; i < count; i++) {
    items.push({
      x: (W / count) * i + Math.random() * (W / count),
      h: layer === 'far' ? 60 + Math.random() * 80 : layer === 'mid' ? 80 + Math.random() * 60 : 40 + Math.random() * 40
    });
  }
  return items;
}

async function startGame() {
  if (selectedChar === null) return;
  const c = CHARACTERS[selectedChar];

  localBest = await getCharBest(selectedChar);
  document.getElementById('hudName').textContent = `${c.name} Â· ${c.charClass}`;
  document.getElementById('hudBest').textContent = `Best: ${localBest}`;

  showScreen('gameScreen');
  resizeCanvas();
  initBgLayers();

  score = 0; speed = BASE_SPEED; frameCount = 0;
  obstacles = []; obstacleTimer = 0; nextObstacleIn = 100; jumpCount = 0;
  player.y = GROUND - player.h; player.vy = 0; player.grounded = true;

  charImg = null;
  if (c.sprite) {
    const img = new Image();
    img.onload = () => { charImg = img; };
    img.src = c.sprite;
  }

  gameRunning = true;
  if (animId) cancelAnimationFrame(animId);
  loop();
}

function retryGame() { startGame(); }

function jump() {
  if (!gameRunning) return;
  if (player.grounded) { player.vy = JUMP_FORCE; player.grounded = false; jumpCount = 1; }
  else if (jumpCount < 2) { player.vy = JUMP_FORCE * 0.85; jumpCount = 2; }
}

document.addEventListener('keydown', e => {
  if (e.code === 'Space' || e.code === 'ArrowUp') { e.preventDefault(); jump(); }
});
canvas.addEventListener('click', () => jump());
document.addEventListener('touchstart', e => { e.preventDefault(); jump(); }, { passive: false });

const OBS_TYPES = [
  { w: 36, h: 56, label: 'ğŸ§Œ', color: '#4a3020' },
  { w: 30, h: 40, label: 'ğŸ’€', color: '#2a3030' },
  { w: 24, h: 64, label: 'ğŸ—¡ï¸', color: '#3a2010' },
  { w: 44, h: 44, label: 'ğŸ•·ï¸', color: '#1a2a1a' },
  { w: 28, h: 52, label: 'ğŸ', color: '#1a3010' },
];

function spawnObstacle() {
  const t = OBS_TYPES[Math.floor(Math.random() * OBS_TYPES.length)];
  obstacles.push({ x: W + 20, y: GROUND - t.h, w: t.w, h: t.h, label: t.label, color: t.color });
}

function loop() {
  if (!gameRunning) return;
  update(); draw();
  animId = requestAnimationFrame(loop);
}

function update() {
  frameCount++;
  score = Math.floor(frameCount / 6);
  speed = BASE_SPEED + frameCount * SPEED_INC;
  document.getElementById('hudScore').textContent = score;

  player.vy += GRAVITY;
  player.y += player.vy;
  if (player.y >= GROUND - player.h) { player.y = GROUND - player.h; player.vy = 0; player.grounded = true; jumpCount = 0; }

  obstacleTimer++;
  if (obstacleTimer >= nextObstacleIn) { spawnObstacle(); obstacleTimer = 0; nextObstacleIn = 90 + Math.random() * 60; }

  for (let i = obstacles.length - 1; i >= 0; i--) {
    obstacles[i].x -= speed;
    if (obstacles[i].x + obstacles[i].w < 0) { obstacles.splice(i, 1); continue; }
    const margin = 10;
    const px = player.x + margin, py = player.y + margin, pw = player.w - margin*2, ph = player.h - margin*2;
    const { x: ox, y: oy, w: ow, h: oh } = obstacles[i];
    if (px < ox+ow && px+pw > ox && py < oy+oh && py+ph > oy) { endGame(); return; }
  }

  bgLayers.forEach(layer => { layer.x -= speed * layer.speed; });
}

function draw() {
  ctx.clearRect(0, 0, W, H);

  // Sky
  const sky = ctx.createLinearGradient(0, 0, 0, GROUND);
  sky.addColorStop(0, '#0a0812'); sky.addColorStop(0.5, '#1a1020'); sky.addColorStop(1, '#2a1a0e');
  ctx.fillStyle = sky; ctx.fillRect(0, 0, W, H);

  // Moon
  ctx.save();
  ctx.beginPath(); ctx.arc(W * 0.8, 50, 30, 0, Math.PI * 2);
  const moonGrad = ctx.createRadialGradient(W*0.8-5, 45, 5, W*0.8, 50, 30);
  moonGrad.addColorStop(0, '#f0e8c0'); moonGrad.addColorStop(1, '#c0a850');
  ctx.fillStyle = moonGrad; ctx.shadowColor = 'rgba(240,232,192,0.4)'; ctx.shadowBlur = 30; ctx.fill(); ctx.restore();

  // Background structures
  bgLayers.forEach((layer, li) => {
    const alphas = [0.15, 0.25, 0.4], colors = ['#2a1a30', '#1a1228', '#2a1810'];
    ctx.fillStyle = colors[li]; ctx.globalAlpha = alphas[li];
    layer.items.forEach(item => {
      let drawX = ((item.x + layer.x) % (W + 200)) - 100;
      if (drawX < -100) drawX += W + 200;
      const bh = item.h, bw = 40 + li * 10;
      ctx.fillRect(drawX, GROUND - bh, bw, bh);
      for (let t = 0; t < 3; t++) ctx.fillRect(drawX + t * (bw/3), GROUND - bh - 14, bw/3 - 4, 14);
      ctx.fillStyle = li === 0 ? 'rgba(201,168,76,0.3)' : 'rgba(0,0,0,0.6)';
      ctx.fillRect(drawX + bw*0.3, GROUND - bh + 20, 8, 12);
      ctx.fillStyle = colors[li];
    });
    ctx.globalAlpha = 1;
  });

  // Stars
  ctx.globalAlpha = 0.6;
  for (let i = 0; i < 60; i++) {
    const sx = (i * 137.5 + frameCount * 0.05) % W;
    const sy = (i * 47.3) % (GROUND * 0.6);
    ctx.fillStyle = i % 5 === 0 ? '#f0d080' : '#ffffff';
    ctx.fillRect(sx, sy, 0.5 + (i % 3) * 0.5, 0.5 + (i % 3) * 0.5);
  }
  ctx.globalAlpha = 1;

  // Ground
  const gGrad = ctx.createLinearGradient(0, GROUND, 0, H);
  gGrad.addColorStop(0, '#3a2a14'); gGrad.addColorStop(0.3, '#2a1e0e'); gGrad.addColorStop(1, '#1a1208');
  ctx.fillStyle = gGrad; ctx.fillRect(0, GROUND, W, H - GROUND);
  ctx.fillStyle = '#4a3820'; ctx.fillRect(0, GROUND, W, 4);
  for (let i = 0; i < W; i += 40) {
    const ox = (i + frameCount * speed * 0.5) % W;
    ctx.fillStyle = (Math.floor(i/40) % 2 === 0) ? '#3a2a14' : '#2e2010';
    ctx.fillRect(ox, GROUND, 38, 4);
  }

  // Obstacles
  obstacles.forEach(obs => {
    ctx.save(); ctx.globalAlpha = 0.3; ctx.fillStyle = '#000';
    ctx.beginPath(); ctx.ellipse(obs.x + obs.w/2, GROUND + 4, obs.w/2, 6, 0, 0, Math.PI*2); ctx.fill(); ctx.restore();
    ctx.fillStyle = obs.color; ctx.strokeStyle = '#5a3a20'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.roundRect(obs.x, obs.y, obs.w, obs.h, 4); ctx.fill(); ctx.stroke();
    ctx.save(); ctx.globalAlpha = 0.8; ctx.shadowColor = '#ff2020'; ctx.shadowBlur = 8; ctx.fillStyle = '#ff4040';
    ctx.fillRect(obs.x + obs.w*0.2, obs.y + obs.h*0.2, 5, 5); ctx.fillRect(obs.x + obs.w*0.6, obs.y + obs.h*0.2, 5, 5); ctx.restore();
    ctx.font = `${Math.min(obs.w - 4, 28)}px serif`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText(obs.label, obs.x + obs.w/2, obs.y + obs.h/2);
  });

  // Player shadow
  ctx.save(); ctx.globalAlpha = 0.25; ctx.fillStyle = '#000';
  ctx.beginPath(); ctx.ellipse(player.x + player.w/2, GROUND + 4, player.w/2, 6, 0, 0, Math.PI*2); ctx.fill(); ctx.restore();

  // Player
  if (charImg) {
    const bob = player.grounded ? Math.sin(frameCount * 0.15) * 2 : 0;
    ctx.save(); ctx.shadowColor = 'rgba(201,168,76,0.5)'; ctx.shadowBlur = 16;
    ctx.drawImage(charImg, player.x, player.y + bob, player.w, player.h); ctx.restore();
  } else {
    const c = CHARACTERS[selectedChar];
    const bob = player.grounded ? Math.sin(frameCount * 0.15) * 2 : 0;
    ctx.save(); ctx.shadowColor = 'rgba(201,168,76,0.5)'; ctx.shadowBlur = 20;
    ctx.font = `${player.h * 0.85}px serif`; ctx.textAlign = 'center'; ctx.textBaseline = 'bottom';
    ctx.fillText(c.emoji, player.x + player.w/2, player.y + player.h + bob); ctx.restore();
  }

  // Double-jump sparkle
  if (!player.grounded && jumpCount === 2) {
    ctx.save(); ctx.globalAlpha = 0.6; ctx.shadowColor = '#f0d080'; ctx.shadowBlur = 10; ctx.fillStyle = '#f0d080';
    for (let i = 0; i < 4; i++) {
      const angle = frameCount * 0.2 + i * Math.PI/2;
      ctx.fillRect(player.x + player.w/2 + Math.cos(angle) * 20 - 2, player.y + player.h * 0.7 + Math.sin(angle) * 10 - 2, 4, 4);
    }
    ctx.restore();
  }
}

async function endGame() {
  gameRunning = false;
  cancelAnimationFrame(animId);

  const newBest = await saveScore(selectedChar, score);
  const isNew = score > localBest;

  document.getElementById('overScore').textContent = score;
  document.getElementById('overBest').innerHTML = `Personal Best: <strong>${newBest}</strong>`;
  document.getElementById('newRecord').classList.toggle('show', isNew);
  document.getElementById('overFlavor').textContent = DEATH_FLAVORS[Math.floor(Math.random() * DEATH_FLAVORS.length)];
  document.getElementById('overRune').textContent = score < 20 ? 'ğŸ’€' : score < 60 ? 'âš”ï¸' : score < 120 ? 'ğŸ›¡ï¸' : 'ğŸ‘‘';

  showScreen('overScreen');
}

window.addEventListener('resize', () => { if (gameRunning) resizeCanvas(); });
</script>
</body>
</html>
